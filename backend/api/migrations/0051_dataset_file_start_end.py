# Generated by Django 3.2.25 on 2024-10-01 11:51

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models

from backend.api.models import AudioMetadatum, DatasetFile


def remove_audio_metadata(apps, schema_editor):
    audio_metadatum: AudioMetadatum = apps.get_model("api", "AudioMetadatum")
    dataset_file: DatasetFile = apps.get_model("api", "DatasetFile")
    audio_metadatum.objects.filter(
        id__in=dataset_file.objects.values_list("audio_metadatum_id", flat=True)
    ).delete()


def reverse_remove_audio_metadata(apps, schema_editor):
    dataset_file: DatasetFile = apps.get_model("api", "DatasetFile")

    for file in dataset_file.objects.all():
        file.audio_metadatum = AudioMetadatum()


class Migration(migrations.Migration):
    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ("api", "0050_alter_annotationtask"),
    ]

    operations = [
        migrations.AddField(
            model_name="datasetfile",
            name="end",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="datasetfile",
            name="start",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="datasetfile",
            name="audio_metadatum",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                to="api.audiometadatum",
            ),
        ),
        migrations.RunSQL(
            """
                UPDATE dataset_files f
                SET start=m.start,
                    "end"=m.end
                FROM audio_metadata m
                WHERE m.id = f.audio_metadatum_id;
            """,
            """
                UPDATE audio_metadata m
                SET start=f.start,
                    "end"=f.end
                FROM dataset_files f
                WHERE m.id = f.audio_metadatum_id;
            """,
        ),
        migrations.AlterModelOptions(
            name="annotationtask",
            options={"ordering": ["dataset_file__start"]},
        ),
        migrations.RunPython(remove_audio_metadata, reverse_remove_audio_metadata),
    ]
